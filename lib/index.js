var t=require("chalk"),e=require("istanbul"),n=require("path"),r=require("puppeteer"),o=require("lodash"),u=require("fs-extra"),c=require("glob"),i=require("./coverage-parser"),a=i.getBranchCoverage,s=i.getFunctionCoverage,f=i.getStatementCoverage,h="＋",d="✗",l=function(t){switch(t){case h:return"green";case d:return"red";default:return"white"}},p=function(t,e){return t?e:{}},y={timeout:2e4,formats:[],output:process.cwd(),puppeteerOptions:{},verbose:!1};module.exports=function(i,m){void 0===m&&(m={});var v=m.coverage;void 0===v&&(v={output:y.output,formats:y.formats});var g=m.verbose;void 0===g&&(g=y.verbose);var w=m.timeout;void 0===w&&(w=y.timeout);var _=m.puppeteerOptions;void 0===_&&(_=y.puppeteerOptions);var b="file:///"+n.join(n.isAbsolute(i)?"":process.cwd(),i).replace(/\\/g,"/"),x=n.join(n.isAbsolute(i)?"":process.cwd(),i),j=n.basename(x,".html"),q=n.join(n.dirname(x),"__snapshots__",j),O=function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];g&&console.log.apply(console,t)};return new Promise(function(i,m){new Promise(function(x,j){var P,U,F,T,C,Q;return P=function(t,e){return new Promise(function(n,r){try{t.on("disconnected",function(){setTimeout(function(){var n=t.process().pid;try{process.kill(n)}catch(t){t&&O("Failed to kill process: "+t)}finally{e&&m(e)}},100)}),t.disconnect()}catch(t){}return n()})},O("Testing",t.magenta(b)),r.launch(_).then(function(r){try{return(U=r).newPage().then(function(r){try{F=r,T=[],C=[],Q=setTimeout(function(){O(),O(t.red("Timeout exceeded.")),O(),P(U,new Error("Timeout exceeded"))},w||y.timeout);var m=function(){try{var r=function(){try{var r=function(){try{try{F.on("load",function(){return new Promise(function(e,r){var i=function(){try{var t=function(){try{return e()}catch(t){return r(t)}},i=function(e){try{return t()}catch(t){return r(t)}};try{return F.exposeFunction("loadSnapshots",function(){return new Promise(function(t,e){var r;return u.ensureDir(q).then(function(u){try{r=c.sync(n.join(q,"*.snap"));try{return t(r.reduce(function(t,e){var r,u=require(e)||{},c=n.basename(e,".snap"),i=Object.entries(u).reduce(function(t,e){var n;return o.extend({},t,((n={})[e[0]]=e[1].trim(),n))},{});return o.extend({},t,((r={})[c]=i,r))},{}))}catch(e){return console.error(e),t({})}return t()}catch(t){return e(t)}},e)})}).then(function(e){try{return F.evaluate(function(){return new Promise(function(t,e){var n;return window.loadSnapshots().then(function(r){try{return n=function(t,e,n){var r;n=n.trim();var o=window.__snapshots__.storage[t],u=Object.assign({},o,((r={})[e]=n,r));window.__snapshots__.storage[t]=u},window.__snapshots__={storage:r,get:function(t,e){return(window.__snapshots__.storage[t]||{})[e]},create:function(t,e,r,o){n(e,r,o),window.snapshotCreated({module:t.test.module.name,name:t.test.testName},e,r)},set:n},QUnit.done(function(t){return window.report(window.__snapshots__.storage,t)}),QUnit.log(window.logAssertion),QUnit.start(),t()}catch(t){return e(t)}},e)})}).then(function(e){try{return t()}catch(t){return i()}},i)}catch(t){return i()}},i)}catch(t){i()}}catch(t){return r(t)}},a=function(t){try{return i()}catch(t){return r(t)}};try{return F.evaluate(function(){return"undefined"==typeof QUnit||!QUnit}).then(function(e){try{if(e)return O(),O(t.red("Unable to find the QUnit object.")),O(),P(U,new Error("Unable to find the QUnit object")).then(function(t){try{return n.call(this)}catch(t){return a()}}.bind(this),a);function n(){return i()}return n.call(this)}catch(t){return a()}}.bind(this),a)}catch(t){a()}})})}catch(t){}var e=function(){try{return x()}catch(t){return j(t)}},r=function(n){try{return O(),O(t.red("Failed to open the test file.")),O(),P(U,new Error("Failed to open the test file.")).then(function(t){try{return e()}catch(t){return j(t)}},j)}catch(t){return j(t)}};try{return F.goto(b).then(function(t){try{return e()}catch(t){return r()}},r)}catch(t){r()}}catch(t){return j(t)}},h=function(t){try{return r()}catch(t){return j(t)}};try{var d;return d=function(t){u.ensureDirSync(q);try{Object.entries(t).forEach(function(t){var e=t[1],r=n.join(q,t[0]+".snap"),c=u.existsSync(r)?require(r):{},i=o.extend({},c,e),a=Object.entries(i).reduce(function(t,e){return t+"module.exports[`"+e[0]+"`] = `\n"+e[1].trim()+"\n`;\n\n"},"");u.writeFileSync(r,a)})}catch(t){console.error(t)}},F.exposeFunction("report",function(n,r){return new Promise(function(u,c){var h,m,w,_,b,x;if(h={},n&&d(n),v)return F.evaluate(function(){return __coverage__}).then(function(n){try{return w=n,_=new e.Collector,b=new e.Reporter(!1,v.output||y.output),x=v.formats||y.formats,g&&!x.includes("text-summary")&&x.push("text-summary"),h=Object.assign({},h,{branch:a(w),function:s(w),statement:f(w)}),_.add(w),b.addAll(x),b.write(_,!0,function(){x.includes("text-summary")&&1===x.length||(O(),O("Coverage written to "+t.magenta(v.output)))}),j.call(this)}catch(t){return c(t)}}.bind(this),c);function j(){O(),m=o.forIn(o.groupBy(T.concat(C),function(t){return t.module}),function(t,e,n){n[e]=o.groupBy(t,function(t){return t.name})}),o.forIn(m,function(e,n){var r=!!n;r&&O(n),o.forIn(e,function(e,n){var u=r?"  ":"";O(u+n),e.forEach(function(e){var n=e.message,r=e.expected,c=e.actual,i=e.category;n&&(n=n.replace(/\n/g,"\n"+u+"      ")),O(t[l(i)](u+"  "+t.bold(i)+" "+(n?t.gray(n):"Test failure"))),o.isUndefined(c)||O(u+"      expected: "+r+", actual: "+c)}),O()})}),O(t.blue("Took "+r.runtime+"ms to run "+r.total+" tests. "+r.passed+" passed, "+r.failed+" failed.\n"));var e=function(){try{return u()}catch(t){return c(t)}},n=function(t){try{return e()}catch(t){return c(t)}};try{return P(U).then(function(t){try{return clearTimeout(Q),i(Object.assign({},{pass:!r.failed,results:o.omit(Object.assign({},r),"runtime")},p(v,{coverage:h}))),e()}catch(t){return n()}},n)}catch(t){n()}}return j.call(this)})}).then(function(t){try{return r()}catch(t){return h()}},h)}catch(t){h()}}catch(t){return j(t)}},h=function(t){try{return r()}catch(t){return j(t)}};try{return F.exposeFunction("logAssertion",function(t){return new Promise(function(e,n){return t.result||t.todo||T.push(o.extend({},t,{category:d})),e()})}).then(function(t){try{return r()}catch(t){return h()}},h)}catch(t){h()}}catch(t){return j(t)}},_=function(t){try{return O(t.message),m()}catch(t){return j(t)}};try{return F.exposeFunction("snapshotCreated",function(t,e,n){return new Promise(function(e,r){return C.push(o.extend({},{category:h,message:"Snapshot `"+n+"` did not exist, so it was created."},t)),e()})}).then(function(t){try{return m()}catch(t){return _(t)}},_)}catch(t){_(t)}}catch(t){return j(t)}},j)}catch(t){return j(t)}},j)})})};
//# sourceMappingURL=index.js.map
