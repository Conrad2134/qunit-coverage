var t=void 0,n=require("chalk"),r=require("istanbul"),e=require("path"),i=require("puppeteer"),u=require("lodash"),o=require("./coverage-parser"),c=o.getBranchCoverage,a=o.getFunctionCoverage,s=o.getStatementCoverage,h=function(t,n){return t?n:{}},d={timeout:1e4,formats:[],output:process.cwd(),puppeteerOptions:{},verbose:!1},f=function(o,f){void 0===f&&(f={});var l=f.coverage;void 0===l&&(l={output:d.output,formats:d.formats});var p=f.verbose;void 0===p&&(p=d.verbose);var b=f.timeout;void 0===b&&(b=d.timeout);var v=f.puppeteerOptions;void 0===v&&(v=d.puppeteerOptions);var m="file:///"+e.join(e.isAbsolute(o)?"":process.cwd(),o).replace(/\\/g,"/"),y=function(){for(var t=[],n=arguments.length;n--;)t[n]=arguments[n];p&&console.log.apply(console,t)};return new Promise(function(e,o){new Promise(function(t,f){var g,w,x,U,P,Q=this;return g=function(t,r){return new Promise(function(e,i){var u=function(){try{return r&&o(r),e()}catch(t){return i(t)}}.bind(this),c=function(t){try{return y(),y(n.yellow("Failed to close Chromium.")),y(),u()}catch(t){return i(t)}}.bind(this);try{return t.close().then(function(t){try{return u()}catch(t){return c(t)}}.bind(this),c)}catch(t){c(t)}}.bind(Q))},y("Testing",n.magenta(m)),i.launch(v).then(function(i){try{return(w=i).newPage().then(function(i){var o=this;try{x=i,U=[],P=setTimeout(function(){y(),y(n.red("Timeout exceeded.")),y(),g(w,new Error("Timeout exceeded"))},b||d.timeout);var v=function(){var i=this;try{var o=function(){var r=this;try{x.on("load",function(){return new Promise(function(t,r){var e=function(){try{var n=function(){try{return t()}catch(t){return r(t)}}.bind(this),e=function(t){try{return n()}catch(t){return r(t)}}.bind(this);try{return x.evaluate(function(){QUnit.done(window.report),QUnit.log(window.logAssertion),QUnit.start()}).then(function(t){try{return n()}catch(t){return e(t)}}.bind(this),e)}catch(t){e(t)}}catch(t){return r(t)}}.bind(this),i=function(t){try{return e()}catch(t){return r(t)}}.bind(this);try{return x.evaluate(function(){return"undefined"==typeof QUnit||!QUnit}).then(function(t){try{if(t)return y(),y(n.red("Unable to find the QUnit object.")),y(),g(w,new Error("Unable to find the QUnit object")).then(function(t){try{return r.call(this)}catch(t){return i(t)}}.bind(this),i);function r(){return e()}return r.call(this)}catch(t){return i(t)}}.bind(this),i)}catch(t){i(t)}}.bind(r))});var e=function(){try{return t()}catch(t){return f(t)}}.bind(this),i=function(t){try{return y(),y(n.red("Failed to open the test file.")),y(),g(w,new Error("Failed to open the test file.")).then(function(t){try{return e()}catch(t){return f(t)}}.bind(this),f)}catch(t){return f(t)}}.bind(this);try{return x.goto(m).then(function(t){try{return e()}catch(t){return i(t)}}.bind(this),i)}catch(t){i(t)}}catch(t){return f(t)}}.bind(this),b=function(t){try{return o()}catch(t){return f(t)}}.bind(this);try{return x.exposeFunction("report",function(t){return new Promise(function(i,o){var f,b,v,m,Q,T;if(T={},l)return x.evaluate(function(){return __coverage__}).then(function(t){try{return f=t,b=new r.Collector,v=new r.Reporter(!1,l.output||d.output),m=l.formats||d.formats,p&&!m.includes("text-summary")&&m.push("text-summary"),T=Object.assign({},T,{branch:c(f),function:a(f),statement:s(f)}),b.add(f),v.addAll(m),v.write(b,!0,function(){m.includes("text-summary")&&1===m.length||(y(),y("Coverage written to "+n.magenta(l.output)))}),j.call(this)}catch(t){return o(t)}}.bind(this),o);function j(){return y(),Q=u.forIn(u.groupBy(U,function(t){return t.module}),function(t,n,r){r[n]=u.groupBy(t,function(t){return t.name})}),u.forIn(Q,function(t,r){var e=!!r;e&&y(r),u.forIn(t,function(t,r){var i=e?"  ":"";y(i+r),t.forEach(function(t){var r=t.message,e=t.expected,o=t.actual;y(n.red(i+"  âœ— "+(r?""+n.gray(r):"Test failure"))),u.isUndefined(o)||y(i+"      expected: "+e+", actual: "+o)}),y()})}),y(n.blue("Took "+t.runtime+"ms to run "+t.total+" tests. "+t.passed+" passed, "+t.failed+" failed.")),g(w).then(function(n){try{return clearTimeout(P),e(Object.assign({},{pass:!t.failed,results:u.omit(Object.assign({},t),"runtime")},h(l,{coverage:T}))),i()}catch(t){return o(t)}}.bind(this),o)}return j.call(this)}.bind(i))}).then(function(t){try{return o()}catch(t){return b(t)}}.bind(this),b)}catch(t){b(t)}}catch(t){return f(t)}}.bind(this),Q=function(t){try{return v()}catch(t){return f(t)}}.bind(this);try{return x.exposeFunction("logAssertion",function(t){return new Promise(function(n,r){return t.result||t.todo||U.push(t),n()}.bind(o))}).then(function(t){try{return v()}catch(t){return Q(t)}}.bind(this),Q)}catch(t){Q(t)}}catch(t){return f(t)}}.bind(this),f)}catch(t){return f(t)}}.bind(this),f)}.bind(t))})};module.exports=f;
//# sourceMappingURL=index.js.map
