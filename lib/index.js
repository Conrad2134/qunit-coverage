var t=require("chalk"),r=require("istanbul"),n=require("path"),e=require("puppeteer"),u=require("lodash"),o=require("fs-extra"),c=require("glob"),i=require("./coverage-parser"),a=i.getBranchCoverage,s=i.getFunctionCoverage,f=i.getStatementCoverage,h=function(t,r){return t?r:{}},l={timeout:2e4,formats:[],output:process.cwd(),puppeteerOptions:{},verbose:!1};module.exports=function(i,p){void 0===p&&(p={});var d=p.coverage;void 0===d&&(d={output:l.output,formats:l.formats});var y=p.verbose;void 0===y&&(y=l.verbose);var m=p.timeout;void 0===m&&(m=l.timeout);var v=p.puppeteerOptions;void 0===v&&(v=l.puppeteerOptions);var w="file:///"+n.join(n.isAbsolute(i)?"":process.cwd(),i).replace(/\\/g,"/"),g=function(){for(var t=[],r=arguments.length;r--;)t[r]=arguments[r];y&&console.log.apply(console,t)};return new Promise(function(p,b){new Promise(function(x,_){var j,P,q,U,F;return j=function(t,r){return new Promise(function(n,e){try{t.on("disconnected",function(){setTimeout(function(){var n=t.process().pid;try{process.kill(n)}catch(t){t&&g("Failed to kill process: "+t)}finally{r&&b(r)}},100)}),t.disconnect()}catch(t){}return n()})},g("Testing",t.magenta(w)),e.launch(v).then(function(e){try{return(P=e).newPage().then(function(e){try{q=e,U=[],F=setTimeout(function(){g(),g(t.red("Timeout exceeded.")),g(),j(P,new Error("Timeout exceeded"))},m||l.timeout);var v=function(){try{var e=function(){try{try{q.on("load",function(){return new Promise(function(r,e){var a=function(){try{var t=function(){try{return r()}catch(t){return e(t)}},a=function(r){try{return t()}catch(t){return e(t)}};try{var s,f,h;return s=n.join(n.isAbsolute(i)?"":process.cwd(),i),f=n.basename(s,".html"),h=n.join(n.dirname(s),"__snapshots__",f),q.exposeFunction("loadSnapshots",function(){return new Promise(function(t,r){var e;return o.ensureDir(h).then(function(o){try{e=c.sync(n.join(h,"*.snap"));try{return t(e.reduce(function(t,r){var e=require(r)||{},o=n.basename(r,".snap"),c=Object.entries(e).reduce(function(t,r){var n;return u.extend({},t,((n={})[o+"."+r[0]]=r[1].trim(),n))},{});return u.extend({},t,c)},{}))}catch(r){return console.error(r),t({})}return t()}catch(t){return r(t)}},r)})}).then(function(r){try{return q.exposeFunction("setSnapshot",function(t,r,e){return new Promise(function(c,i){return o.ensureDir(h).then(function(a){var s;try{var f=function(){try{return c()}catch(t){return i(t)}},l=function(t){try{return console.error(t),f()}catch(t){return i(t)}};try{var p,d,y,m;return p=n.join(h,t+".snap"),d=o.existsSync(p)?require(p):{exports:{}},y={exports:u.extend({},d.exports,(s={},s[r]=e,s))},m=Object.entries(y.exports).reduce(function(t,r){return t+"module.exports[`"+r[0]+"`] = `\n"+r[1]+"\n`;\n\n"},""),o.writeFile(p,m).then(function(t){try{return f()}catch(t){return l(t)}},l)}catch(t){l(t)}}catch(t){return i(t)}},i)})}).then(function(r){try{return q.evaluate(function(){return new Promise(function(t,r){return window.loadSnapshots().then(function(n){try{return window.__snapshots__={storage:n,get:function(t,r){return window.__snapshots__.storage[t+"."+r]},set:function(t,r,n){return new Promise(function(e,u){return n=n.trim(),window.__snapshots__.storage[t+"."+r]=n,window.setSnapshot(t,r,n).then(function(t){try{return e()}catch(t){return u(t)}},u)})}},QUnit.done(window.report),QUnit.log(window.logAssertion),QUnit.start(),t()}catch(t){return r(t)}},r)})}).then(function(r){try{return t()}catch(t){return a()}},a)}catch(t){return a()}},a)}catch(t){return a()}},a)}catch(t){a()}}catch(t){return e(t)}},s=function(t){try{return a()}catch(t){return e(t)}};try{return q.evaluate(function(){return"undefined"==typeof QUnit||!QUnit}).then(function(r){try{if(r)return g(),g(t.red("Unable to find the QUnit object.")),g(),j(P,new Error("Unable to find the QUnit object")).then(function(t){try{return n.call(this)}catch(t){return s()}}.bind(this),s);function n(){return a()}return n.call(this)}catch(t){return s()}}.bind(this),s)}catch(t){s()}})})}catch(t){}var r=function(){try{return x()}catch(t){return _(t)}},e=function(n){try{return g(),g(t.red("Failed to open the test file.")),g(),j(P,new Error("Failed to open the test file.")).then(function(t){try{return r()}catch(t){return _(t)}},_)}catch(t){return _(t)}};try{return q.goto(w).then(function(t){try{return r()}catch(t){return e()}},e)}catch(t){e()}}catch(t){return _(t)}},m=function(t){try{return e()}catch(t){return _(t)}};try{return q.exposeFunction("report",function(n){return new Promise(function(e,o){var c,i,m,v,w,b;if(c={},d)return q.evaluate(function(){return __coverage__}).then(function(n){try{return m=n,v=new r.Collector,w=new r.Reporter(!1,d.output||l.output),b=d.formats||l.formats,y&&!b.includes("text-summary")&&b.push("text-summary"),c=Object.assign({},c,{branch:a(m),function:s(m),statement:f(m)}),v.add(m),w.addAll(b),w.write(v,!0,function(){b.includes("text-summary")&&1===b.length||(g(),g("Coverage written to "+t.magenta(d.output)))}),x.call(this)}catch(t){return o(t)}}.bind(this),o);function x(){g(),i=u.forIn(u.groupBy(U,function(t){return t.module}),function(t,r,n){n[r]=u.groupBy(t,function(t){return t.name})}),u.forIn(i,function(r,n){var e=!!n;e&&g(n),u.forIn(r,function(r,n){var o=e?"  ":"";g(o+n),r.forEach(function(r){var n=r.message,e=r.expected,c=r.actual;g(t.red(o+"  âœ— "+(n?""+t.gray(n):"Test failure"))),u.isUndefined(c)||g(o+"      expected: "+e+", actual: "+c)}),g()})}),g(t.blue("Took "+n.runtime+"ms to run "+n.total+" tests. "+n.passed+" passed, "+n.failed+" failed."));var r=function(){try{return e()}catch(t){return o(t)}},a=function(t){try{return r()}catch(t){return o(t)}};try{return j(P).then(function(t){try{return clearTimeout(F),p(Object.assign({},{pass:!n.failed,results:u.omit(Object.assign({},n),"runtime")},h(d,{coverage:c}))),r()}catch(t){return a()}},a)}catch(t){a()}}return x.call(this)})}).then(function(t){try{return e()}catch(t){return m()}},m)}catch(t){m()}}catch(t){return _(t)}},b=function(t){try{return v()}catch(t){return _(t)}};try{return q.exposeFunction("logAssertion",function(t){return new Promise(function(r,n){return t.result||t.todo||U.push(t),r()})}).then(function(t){try{return v()}catch(t){return b()}},b)}catch(t){b()}}catch(t){return _(t)}},_)}catch(t){return _(t)}},_)})})};
//# sourceMappingURL=index.js.map
