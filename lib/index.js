var t=void 0,n=require("chalk"),r=require("istanbul"),e=require("path"),i=require("puppeteer"),u=require("lodash"),o=require("./coverage-parser"),c=o.getBranchCoverage,a=o.getFunctionCoverage,s=o.getStatementCoverage,h=function(t,n){return t?n:{}},f={timeout:1e4,formats:[],output:process.cwd(),verbose:!1},d=function(o,d){void 0===d&&(d={});var l=d.coverage;void 0===l&&(l={output:f.output,formats:f.formats});var b=d.verbose;void 0===b&&(b=f.verbose);var m=d.timeout;void 0===m&&(m=f.timeout);var v="file:///"+e.join(e.isAbsolute(o)?"":process.cwd(),o).replace(/\\/g,"/"),y=function(){for(var t=[],n=arguments.length;n--;)t[n]=arguments[n];b&&console.log.apply(console,t)};return new Promise(function(e,o){new Promise(function(t,d){var p,g,w,x,U,P=this;return p=function(t,r){return new Promise(function(e,i){var u=function(){try{return r&&o(r),e()}catch(t){return i(t)}}.bind(this),c=function(t){try{return y(),y(n.yellow("Failed to close Chromium.")),y(),u()}catch(t){return i(t)}}.bind(this);try{return t.close().then(function(t){try{return u()}catch(t){return c(t)}}.bind(this),c)}catch(t){c(t)}}.bind(P))},y("Testing",n.magenta(v)),i.launch().then(function(i){try{return(g=i).newPage().then(function(i){var o=this;try{w=i,x=[],U=setTimeout(function(){y(),y(n.red("Timeout exceeded.")),y(),p(g,new Error("Timeout exceeded"))},m||f.timeout);var P=function(){var i=this;try{var o=function(){var r=this;try{w.on("load",function(){return new Promise(function(t,r){var e=function(){try{var n=function(){try{return t()}catch(t){return r(t)}}.bind(this),e=function(t){try{return n()}catch(t){return r(t)}}.bind(this);try{return w.evaluate(function(){QUnit.done(window.report),QUnit.log(window.logAssertion),QUnit.start()}).then(function(t){try{return n()}catch(t){return e(t)}}.bind(this),e)}catch(t){e(t)}}catch(t){return r(t)}}.bind(this),i=function(t){try{return e()}catch(t){return r(t)}}.bind(this);try{return w.evaluate(function(){return"undefined"==typeof QUnit||!QUnit}).then(function(t){try{if(t)return y(),y(n.red("Unable to find the QUnit object.")),y(),p(g,new Error("Unable to find the QUnit object")).then(function(t){try{return r.call(this)}catch(t){return i(t)}}.bind(this),i);function r(){return e()}return r.call(this)}catch(t){return i(t)}}.bind(this),i)}catch(t){i(t)}}.bind(r))});var e=function(){try{return t()}catch(t){return d(t)}}.bind(this),i=function(t){try{return y(),y(n.red("Failed to open the test file.")),y(),p(g,new Error("Failed to open the test file.")).then(function(t){try{return e()}catch(t){return d(t)}}.bind(this),d)}catch(t){return d(t)}}.bind(this);try{return w.goto(v).then(function(t){try{return e()}catch(t){return i(t)}}.bind(this),i)}catch(t){i(t)}}catch(t){return d(t)}}.bind(this),m=function(t){try{return o()}catch(t){return d(t)}}.bind(this);try{return w.exposeFunction("report",function(t){return new Promise(function(i,o){var d,m,v,P,Q,T;if(T={},l)return w.evaluate(function(){return __coverage__}).then(function(t){try{return d=t,m=new r.Collector,v=new r.Reporter(!1,l.output||f.output),P=l.formats||f.formats,b&&!P.includes("text-summary")&&P.push("text-summary"),T=Object.assign({},T,{branch:c(d),function:a(d),statement:s(d)}),m.add(d),v.addAll(P),v.write(m,!0,function(){P.includes("text-summary")&&1===P.length||(y(),y("Coverage written to "+n.magenta(l.output)))}),j.call(this)}catch(t){return o(t)}}.bind(this),o);function j(){return y(),Q=u.forIn(u.groupBy(x,function(t){return t.module}),function(t,n,r){r[n]=u.groupBy(t,function(t){return t.name})}),u.forIn(Q,function(t,r){var e=!!r;e&&y(r),u.forIn(t,function(t,r){var i=e?"  ":"";y(i+r),t.forEach(function(t){var r=t.message,e=t.expected,o=t.actual;y(n.red(i+"  âœ— "+(r?""+n.gray(r):"Test failure"))),u.isUndefined(o)||y(i+"      expected: "+e+", actual: "+o)}),y()})}),y(n.blue("Took "+t.runtime+"ms to run "+t.total+" tests. "+t.passed+" passed, "+t.failed+" failed.")),p(g).then(function(n){try{return clearTimeout(U),e(Object.assign({},{pass:!t.failed,results:u.omit(Object.assign({},t),"runtime")},h(l,{coverage:T}))),i()}catch(t){return o(t)}}.bind(this),o)}return j.call(this)}.bind(i))}).then(function(t){try{return o()}catch(t){return m(t)}}.bind(this),m)}catch(t){m(t)}}catch(t){return d(t)}}.bind(this),Q=function(t){try{return P()}catch(t){return d(t)}}.bind(this);try{return w.exposeFunction("logAssertion",function(t){return new Promise(function(n,r){return t.result||t.todo||x.push(t),n()}.bind(o))}).then(function(t){try{return P()}catch(t){return Q(t)}}.bind(this),Q)}catch(t){Q(t)}}catch(t){return d(t)}}.bind(this),d)}catch(t){return d(t)}}.bind(this),d)}.bind(t))})};module.exports=d;
//# sourceMappingURL=index.js.map
