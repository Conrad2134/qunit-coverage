var t=require("chalk"),n=require("istanbul"),r=require("path"),e=require("puppeteer"),u=require("lodash"),o=require("fs-extra"),c=require("glob"),i=require("./coverage-parser"),a=i.getBranchCoverage,s=i.getFunctionCoverage,f=i.getStatementCoverage,h=function(t,n){return t?n:{}},l={timeout:2e4,formats:[],output:process.cwd(),puppeteerOptions:{},verbose:!1};module.exports=function(i,d){void 0===d&&(d={});var p=d.coverage;void 0===p&&(p={output:l.output,formats:l.formats});var y=d.verbose;void 0===y&&(y=l.verbose);var m=d.timeout;void 0===m&&(m=l.timeout);var v=d.puppeteerOptions;void 0===v&&(v=l.puppeteerOptions);var w="file:///"+r.join(r.isAbsolute(i)?"":process.cwd(),i).replace(/\\/g,"/"),g=function(){for(var t=[],n=arguments.length;n--;)t[n]=arguments[n];y&&console.log.apply(console,t)};return new Promise(function(d,b){new Promise(function(_,x){var P,j,F,U,q;return P=function(t,n){return new Promise(function(r,e){try{t.on("disconnected",function(){setTimeout(function(){var r=t.process().pid;g("Browser disconnected... PID: "+r);try{process.kill(r)}catch(t){t&&g("Failed to kill process: "+t)}finally{n&&b(n)}},100)}),t.disconnect()}catch(t){}return r()})},g("Testing",t.magenta(w)),e.launch(v).then(function(e){try{return(j=e).newPage().then(function(e){try{F=e,U=[],q=setTimeout(function(){g(),g(t.red("Timeout exceeded.")),g(),P(j,new Error("Timeout exceeded"))},m||l.timeout);var v=function(){try{var e=function(){try{try{F.on("load",function(){return new Promise(function(n,e){var u=function(){try{var t=function(){try{return n()}catch(t){return e(t)}},u=function(n){try{return t()}catch(t){return e(t)}};try{var a,s,f;return a=r.join(r.isAbsolute(i)?"":process.cwd(),i),s=r.basename(a,".html"),f=r.join(r.dirname(a),"__snapshot__",s),F.exposeFunction("loadSnapshots",function(){return new Promise(function(t,n){return o.ensureDir(f).then(function(e){try{return c.sync(r.join(f,"*.snapshot")).then(function(e){try{return t(e.reduce(function(t,n){var e;return Object.assign({},t,((e={})[r.basename(n,".snapshot")]=o.readFileSync(n,"utf-8"),e))},{}))}catch(t){return n(t)}},n)}catch(t){return n(t)}},n)})}).then(function(n){try{return F.exposeFunction("setSnapshot",function(t,n){return new Promise(function(e,u){return o.ensureDir(f).then(function(c){try{return o.writeFile(r.join(f,t+".snapshot"),n).then(function(t){try{return e()}catch(t){return u(t)}},u)}catch(t){return u(t)}},u)})}).then(function(n){try{return F.evaluate(function(){return new Promise(function(t,n){return window.loadSnapshots().then(function(r){try{return window.__snapshot__={storage:r,get:function(t){return window.__snapshot__.storage[t]},set:function(t,n){return new Promise(function(r,e){return window.__snapshot__.storage[t]=n,window.setSnapshot(t,n).then(function(t){try{return r()}catch(t){return e(t)}},e)})}},QUnit.done(window.report),QUnit.log(window.logAssertion),QUnit.start(),t()}catch(t){return n(t)}},n)})}).then(function(n){try{return t()}catch(t){return u()}},u)}catch(t){return u()}},u)}catch(t){return u()}},u)}catch(t){u()}}catch(t){return e(t)}},a=function(t){try{return u()}catch(t){return e(t)}};try{return F.evaluate(function(){return"undefined"==typeof QUnit||!QUnit}).then(function(n){try{if(n)return g(),g(t.red("Unable to find the QUnit object.")),g(),P(j,new Error("Unable to find the QUnit object")).then(function(t){try{return r.call(this)}catch(t){return a()}}.bind(this),a);function r(){return u()}return r.call(this)}catch(t){return a()}}.bind(this),a)}catch(t){a()}})})}catch(t){}var n=function(){try{return _()}catch(t){return x(t)}},e=function(r){try{return g(),g(t.red("Failed to open the test file.")),g(),P(j,new Error("Failed to open the test file.")).then(function(t){try{return n()}catch(t){return x(t)}},x)}catch(t){return x(t)}};try{return F.goto(w).then(function(t){try{return n()}catch(t){return e()}},e)}catch(t){e()}}catch(t){return x(t)}},m=function(t){try{return e()}catch(t){return x(t)}};try{return F.exposeFunction("report",function(r){return new Promise(function(e,o){var c,i,m,v,w,b;if(c={},p)return F.evaluate(function(){return __coverage__}).then(function(r){try{return m=r,v=new n.Collector,w=new n.Reporter(!1,p.output||l.output),b=p.formats||l.formats,y&&!b.includes("text-summary")&&b.push("text-summary"),c=Object.assign({},c,{branch:a(m),function:s(m),statement:f(m)}),v.add(m),w.addAll(b),w.write(v,!0,function(){b.includes("text-summary")&&1===b.length||(g(),g("Coverage written to "+t.magenta(p.output)))}),_.call(this)}catch(t){return o(t)}}.bind(this),o);function _(){g(),i=u.forIn(u.groupBy(U,function(t){return t.module}),function(t,n,r){r[n]=u.groupBy(t,function(t){return t.name})}),u.forIn(i,function(n,r){var e=!!r;e&&g(r),u.forIn(n,function(n,r){var o=e?"  ":"";g(o+r),n.forEach(function(n){var r=n.message,e=n.expected,c=n.actual;g(t.red(o+"  âœ— "+(r?""+t.gray(r):"Test failure"))),u.isUndefined(c)||g(o+"      expected: "+e+", actual: "+c)}),g()})}),g(t.blue("Took "+r.runtime+"ms to run "+r.total+" tests. "+r.passed+" passed, "+r.failed+" failed."));var n=function(){try{return e()}catch(t){return o(t)}},a=function(t){try{return n()}catch(t){return o(t)}};try{return P(j).then(function(t){try{return clearTimeout(q),d(Object.assign({},{pass:!r.failed,results:u.omit(Object.assign({},r),"runtime")},h(p,{coverage:c}))),n()}catch(t){return a()}},a)}catch(t){a()}}return _.call(this)})}).then(function(t){try{return e()}catch(t){return m()}},m)}catch(t){m()}}catch(t){return x(t)}},b=function(t){try{return v()}catch(t){return x(t)}};try{return F.exposeFunction("logAssertion",function(t){return new Promise(function(n,r){return t.result||t.todo||U.push(t),n()})}).then(function(t){try{return v()}catch(t){return b()}},b)}catch(t){b()}}catch(t){return x(t)}},x)}catch(t){return x(t)}},x)})})};
//# sourceMappingURL=index.js.map
