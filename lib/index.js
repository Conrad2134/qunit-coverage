var t=require("chalk"),r=require("istanbul"),e=require("path"),n=require("puppeteer"),u=require("lodash"),o=require("./coverage-parser"),c=o.getBranchCoverage,i=o.getFunctionCoverage,a=o.getStatementCoverage,s=function(t,r){return t?r:{}},f={timeout:1e4,formats:[],output:process.cwd(),puppeteerOptions:{},verbose:!1};module.exports=function(o,h){void 0===h&&(h={});var l=h.coverage;void 0===l&&(l={output:f.output,formats:f.formats});var d=h.verbose;void 0===d&&(d=f.verbose);var p=h.timeout;void 0===p&&(p=f.timeout);var y=h.puppeteerOptions;void 0===y&&(y=f.puppeteerOptions);var m="file:///"+e.join(e.isAbsolute(o)?"":process.cwd(),o).replace(/\\/g,"/"),v=function(){for(var t=[],r=arguments.length;r--;)t[r]=arguments[r];d&&console.log.apply(console,t)};return v(y),new Promise(function(e,o){new Promise(function(h,g){var w,b,x,U,P;return w=function(r,e){return new Promise(function(n,u){var c=function(t){return function(r){try{return e&&o(e),t&&t.call(this,r)}catch(t){return u(t)}}.bind(this)}.bind(this),i=function(){try{return n()}catch(t){return u(t)}},a=function(r){try{return v(),v(t.yellow("Failed to close Chromium.")),v(),c(i)()}catch(t){return c(u)(t)}};try{return r.close().then(function(t){try{return c(i)()}catch(t){return a()}},a)}catch(t){a()}})},v("Testing",t.magenta(m)),n.launch(y).then(function(n){try{return(b=n).newPage().then(function(n){try{x=n,U=[],P=setTimeout(function(){v(),v(t.red("Timeout exceeded.")),v(),w(b,new Error("Timeout exceeded"))},p||f.timeout);var o=function(){try{var n=function(){try{x.on("load",function(){return new Promise(function(r,e){var n=function(){try{var t=function(){try{return r()}catch(t){return e(t)}},n=function(r){try{return t()}catch(t){return e(t)}};try{return x.evaluate(function(){QUnit.done(window.report),QUnit.log(window.logAssertion),QUnit.start()}).then(function(r){try{return t()}catch(t){return n()}},n)}catch(t){n()}}catch(t){return e(t)}},u=function(t){try{return n()}catch(t){return e(t)}};try{return x.evaluate(function(){return"undefined"==typeof QUnit||!QUnit}).then(function(r){try{if(r)return v(),v(t.red("Unable to find the QUnit object.")),v(),w(b,new Error("Unable to find the QUnit object")).then(function(t){try{return e.call(this)}catch(t){return u()}}.bind(this),u);function e(){return n()}return e.call(this)}catch(t){return u()}}.bind(this),u)}catch(t){u()}})});var r=function(){try{return h()}catch(t){return g(t)}},e=function(e){try{return v(),v(t.red("Failed to open the test file.")),v(),w(b,new Error("Failed to open the test file.")).then(function(t){try{return r()}catch(t){return g(t)}},g)}catch(t){return g(t)}};try{return x.goto(m).then(function(t){try{return r()}catch(t){return e()}},e)}catch(t){e()}}catch(t){return g(t)}},o=function(t){try{return n()}catch(t){return g(t)}};try{return x.exposeFunction("report",function(n){return new Promise(function(o,h){var p,y,m,g,Q,T;if(p={},l)return x.evaluate(function(){return __coverage__}).then(function(e){try{return m=e,g=new r.Collector,Q=new r.Reporter(!1,l.output||f.output),T=l.formats||f.formats,d&&!T.includes("text-summary")&&T.push("text-summary"),p=Object.assign({},p,{branch:c(m),function:i(m),statement:a(m)}),g.add(m),Q.addAll(T),Q.write(g,!0,function(){T.includes("text-summary")&&1===T.length||(v(),v("Coverage written to "+t.magenta(l.output)))}),j.call(this)}catch(t){return h(t)}}.bind(this),h);function j(){v(),y=u.forIn(u.groupBy(U,function(t){return t.module}),function(t,r,e){e[r]=u.groupBy(t,function(t){return t.name})}),u.forIn(y,function(r,e){var n=!!e;n&&v(e),u.forIn(r,function(r,e){var o=n?"  ":"";v(o+e),r.forEach(function(r){var e=r.message,n=r.expected,c=r.actual;v(t.red(o+"  âœ— "+(e?""+t.gray(e):"Test failure"))),u.isUndefined(c)||v(o+"      expected: "+n+", actual: "+c)}),v()})}),v(t.blue("Took "+n.runtime+"ms to run "+n.total+" tests. "+n.passed+" passed, "+n.failed+" failed."));var r=function(){try{return o()}catch(t){return h(t)}},c=function(t){try{return r()}catch(t){return h(t)}};try{return w(b).then(function(t){try{return clearTimeout(P),e(Object.assign({},{pass:!n.failed,results:u.omit(Object.assign({},n),"runtime")},s(l,{coverage:p}))),r()}catch(t){return c()}},c)}catch(t){c()}}return j.call(this)})}).then(function(t){try{return n()}catch(t){return o()}},o)}catch(t){o()}}catch(t){return g(t)}},y=function(t){try{return o()}catch(t){return g(t)}};try{return x.exposeFunction("logAssertion",function(t){return new Promise(function(r,e){return t.result||t.todo||U.push(t),r()})}).then(function(t){try{return o()}catch(t){return y()}},y)}catch(t){y()}}catch(t){return g(t)}},g)}catch(t){return g(t)}},g)})})};
//# sourceMappingURL=index.js.map
