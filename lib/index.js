var t=require("chalk"),r=require("istanbul"),n=require("path"),e=require("puppeteer"),u=require("lodash"),o=require("fs-extra"),c=require("glob"),i=require("./coverage-parser"),a=i.getBranchCoverage,s=i.getFunctionCoverage,f=i.getStatementCoverage,h=function(t,r){return t?r:{}},d={timeout:2e4,formats:[],output:process.cwd(),puppeteerOptions:{},verbose:!1};module.exports=function(i,l){void 0===l&&(l={});var p=l.coverage;void 0===p&&(p={output:d.output,formats:d.formats});var y=l.verbose;void 0===y&&(y=d.verbose);var m=l.timeout;void 0===m&&(m=d.timeout);var v=l.puppeteerOptions;void 0===v&&(v=d.puppeteerOptions);var g="file:///"+n.join(n.isAbsolute(i)?"":process.cwd(),i).replace(/\\/g,"/"),w=n.join(n.isAbsolute(i)?"":process.cwd(),i),_=n.basename(w,".html"),b=n.join(n.dirname(w),"__snapshots__",_),x=function(){for(var t=[],r=arguments.length;r--;)t[r]=arguments[r];y&&console.log.apply(console,t)};return new Promise(function(i,l){new Promise(function(w,_){var j,q,O,P,U;return j=function(t,r){return new Promise(function(n,e){try{t.on("disconnected",function(){setTimeout(function(){var n=t.process().pid;try{process.kill(n)}catch(t){t&&x("Failed to kill process: "+t)}finally{r&&l(r)}},100)}),t.disconnect()}catch(t){}return n()})},x("Testing",t.magenta(g)),e.launch(v).then(function(e){try{return(q=e).newPage().then(function(e){try{O=e,P=[],U=setTimeout(function(){x(),x(t.red("Timeout exceeded.")),x(),j(q,new Error("Timeout exceeded"))},m||d.timeout);var l=function(){try{var e=function(){try{try{O.on("load",function(){return new Promise(function(r,e){var i=function(){try{var t=function(){try{return r()}catch(t){return e(t)}},i=function(r){try{return t()}catch(t){return e(t)}};try{return O.exposeFunction("loadSnapshots",function(){return new Promise(function(t,r){var e;return o.ensureDir(b).then(function(o){try{e=c.sync(n.join(b,"*.snap"));try{return t(e.reduce(function(t,r){var e,o=require(r)||{},c=n.basename(r,".snap"),i=Object.entries(o).reduce(function(t,r){var n;return u.extend({},t,((n={})[r[0]]=r[1].trim(),n))},{});return u.extend({},t,((e={})[c]=i,e))},{}))}catch(r){return console.error(r),t({})}return t()}catch(t){return r(t)}},r)})}).then(function(r){try{return O.evaluate(function(){return new Promise(function(t,r){return window.loadSnapshots().then(function(n){try{return window.__snapshots__={storage:n,get:function(t,r){return(window.__snapshots__.storage[t]||{})[r]},set:function(t,r,n){return new Promise(function(e,u){var o;n=n.trim();var c=window.__snapshots__.storage[t],i=Object.assign({},c,((o={})[r]=n,o));return window.__snapshots__.storage[t]=i,e()})}},QUnit.done(function(t){return window.report(window.__snapshots__.storage,t)}),QUnit.log(window.logAssertion),QUnit.start(),t()}catch(t){return r(t)}},r)})}).then(function(r){try{return t()}catch(t){return i()}},i)}catch(t){return i()}},i)}catch(t){i()}}catch(t){return e(t)}},a=function(t){try{return i()}catch(t){return e(t)}};try{return O.evaluate(function(){return"undefined"==typeof QUnit||!QUnit}).then(function(r){try{if(r)return x(),x(t.red("Unable to find the QUnit object.")),x(),j(q,new Error("Unable to find the QUnit object")).then(function(t){try{return n.call(this)}catch(t){return a()}}.bind(this),a);function n(){return i()}return n.call(this)}catch(t){return a()}}.bind(this),a)}catch(t){a()}})})}catch(t){}var r=function(){try{return w()}catch(t){return _(t)}},e=function(n){try{return x(),x(t.red("Failed to open the test file.")),x(),j(q,new Error("Failed to open the test file.")).then(function(t){try{return r()}catch(t){return _(t)}},_)}catch(t){return _(t)}};try{return O.goto(g).then(function(t){try{return r()}catch(t){return e()}},e)}catch(t){e()}}catch(t){return _(t)}},l=function(t){try{return e()}catch(t){return _(t)}};try{var m;return m=function(t){o.ensureDirSync(b);try{Object.entries(t).forEach(function(t){var r=t[1],e=n.join(b,t[0]+".snap"),c=o.existsSync(e)?require(e):{},i=u.extend({},c,r),a=Object.entries(i).reduce(function(t,r){return t+"module.exports[`"+r[0]+"`] = `\n"+r[1].trim()+"\n`;\n\n"},"");o.writeFileSync(e,a)})}catch(t){console.error(t)}},O.exposeFunction("report",function(n,e){return new Promise(function(o,c){var l,v,g,w,_,b;if(l={},n&&m(n),p)return O.evaluate(function(){return __coverage__}).then(function(n){try{return g=n,w=new r.Collector,_=new r.Reporter(!1,p.output||d.output),b=p.formats||d.formats,y&&!b.includes("text-summary")&&b.push("text-summary"),l=Object.assign({},l,{branch:a(g),function:s(g),statement:f(g)}),w.add(g),_.addAll(b),_.write(w,!0,function(){b.includes("text-summary")&&1===b.length||(x(),x("Coverage written to "+t.magenta(p.output)))}),F.call(this)}catch(t){return c(t)}}.bind(this),c);function F(){x(),v=u.forIn(u.groupBy(P,function(t){return t.module}),function(t,r,n){n[r]=u.groupBy(t,function(t){return t.name})}),u.forIn(v,function(r,n){var e=!!n;e&&x(n),u.forIn(r,function(r,n){var o=e?"  ":"";x(o+n),r.forEach(function(r){var n=r.message,e=r.expected,c=r.actual;x(t.red(o+"  âœ— "+(n?""+t.gray(n):"Test failure"))),u.isUndefined(c)||x(o+"      expected: "+e+", actual: "+c)}),x()})}),x(t.blue("Took "+e.runtime+"ms to run "+e.total+" tests. "+e.passed+" passed, "+e.failed+" failed."));var r=function(){try{return o()}catch(t){return c(t)}},n=function(t){try{return r()}catch(t){return c(t)}};try{return j(q).then(function(t){try{return clearTimeout(U),i(Object.assign({},{pass:!e.failed,results:u.omit(Object.assign({},e),"runtime")},h(p,{coverage:l}))),r()}catch(t){return n()}},n)}catch(t){n()}}return F.call(this)})}).then(function(t){try{return e()}catch(t){return l()}},l)}catch(t){l()}}catch(t){return _(t)}},v=function(t){try{return l()}catch(t){return _(t)}};try{return O.exposeFunction("logAssertion",function(t){return new Promise(function(r,n){return t.result||t.todo||P.push(t),r()})}).then(function(t){try{return l()}catch(t){return v()}},v)}catch(t){v()}}catch(t){return _(t)}},_)}catch(t){return _(t)}},_)})})};
//# sourceMappingURL=index.js.map
