{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["/* global QUnit, window, __coverage__ */\n\nconst chalk = require(\"chalk\");\nconst istanbul = require(\"istanbul\");\nconst path = require(\"path\");\nconst puppeteer = require(\"puppeteer\");\nconst _ = require(\"lodash\");\nconst fs = require(\"fs-extra\");\nconst glob = require(\"glob\");\n\nconst { getBranchCoverage, getFunctionCoverage, getStatementCoverage } = require(\"./coverage-parser\");\n\nconst spreadObjectIf = (condition, element) => (condition ? element : {});\n\nconst defaults = {\n\ttimeout: 20000,\n\tformats: [],\n\toutput: process.cwd(),\n\tpuppeteerOptions: {},\n\tverbose: false,\n};\n\nconst qunitChromeRunner = (\n\tfilePath,\n\t{\n\t\tcoverage = { output: defaults.output, formats: defaults.formats },\n\t\tverbose = defaults.verbose,\n\t\ttimeout = defaults.timeout,\n\t\tpuppeteerOptions = defaults.puppeteerOptions,\n\t} = {},\n) => {\n\tconst fixturePath = `file:///${path.join(path.isAbsolute(filePath) ? \"\" : process.cwd(), filePath).replace(/\\\\/g, \"/\")}`;\n\tconst log = (...val) => {\n\t\tif (verbose) {\n\t\t\tconsole.log(...val);\n\t\t}\n\t};\n\n\t//\toptions:\n\t//\t\ttimeout\n\t//\t\tverbose\n\t//\t\tpuppeteerOptions: { /* options to pass to puppeteer */ }\n\t//\t\t`coverage: { output: \"...\", formats: [\"json\", ...] }` OR `coverage: false`\n\n\treturn new Promise((resolve, reject) => {\n\t\t(async () => {\n\t\t\tconst closeBrowser = async (browser, rejection) => {\n\t\t\t\ttry {\n\t\t\t\t\tbrowser.on(\"disconnected\", () => {\n\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\tconst { pid } = browser.process();\n\t\t\t\t\t\t\tlog(`Browser disconnected... PID: ${pid}`);\n\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\tprocess.kill(pid);\n\t\t\t\t\t\t\t} catch (ex) {\n\t\t\t\t\t\t\t\tif (ex) {\n\t\t\t\t\t\t\t\t\tlog(`Failed to kill process: ${ex}`);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t} finally {\n\t\t\t\t\t\t\t\tif (rejection) {\n\t\t\t\t\t\t\t\t\treject(rejection);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}, 100);\n\t\t\t\t\t});\n\n\t\t\t\t\tbrowser.disconnect();\n\t\t\t\t} catch (ex) {\n\t\t\t\t\t// Silently handle, for now.\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tlog(\"Testing\", chalk.magenta(fixturePath));\n\n\t\t\tconst browser = await puppeteer.launch(puppeteerOptions);\n\t\t\tconst page = await browser.newPage();\n\t\t\tconst failures = [];\n\n\t\t\t// Setting our timeout in case everything below takes too long\n\t\t\tconst timer = setTimeout(() => {\n\t\t\t\tlog();\n\t\t\t\tlog(chalk.red(\"Timeout exceeded.\"));\n\t\t\t\tlog();\n\n\t\t\t\tcloseBrowser(browser, new Error(\"Timeout exceeded\"));\n\t\t\t}, timeout || defaults.timeout);\n\n\t\t\ttry {\n\t\t\t\tawait page.exposeFunction(\"logAssertion\", async response => {\n\t\t\t\t\t// Don't log if the test passed or it's a todo test\n\t\t\t\t\tif (!response.result && !response.todo) {\n\t\t\t\t\t\tfailures.push(response);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} catch (ex) {\n\t\t\t\t// Silently handle, for now.\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tawait page.exposeFunction(\"report\", async response => {\n\t\t\t\t\tlet coverageReport = {};\n\n\t\t\t\t\tif (coverage) {\n\t\t\t\t\t\tconst coverageResults = await page.evaluate(() => __coverage__);\n\t\t\t\t\t\tconst collector = new istanbul.Collector();\n\t\t\t\t\t\tconst reporter = new istanbul.Reporter(false, coverage.output || defaults.output);\n\t\t\t\t\t\tconst formats = coverage.formats || defaults.formats;\n\n\t\t\t\t\t\tif (verbose && !formats.includes(\"text-summary\")) {\n\t\t\t\t\t\t\tformats.push(\"text-summary\");\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tcoverageReport = Object.assign({}, coverageReport, {\n\t\t\t\t\t\t\tbranch: getBranchCoverage(coverageResults),\n\t\t\t\t\t\t\tfunction: getFunctionCoverage(coverageResults),\n\t\t\t\t\t\t\tstatement: getStatementCoverage(coverageResults),\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tcollector.add(coverageResults);\n\n\t\t\t\t\t\treporter.addAll(formats);\n\t\t\t\t\t\treporter.write(collector, true, () => {\n\t\t\t\t\t\t\tif (!formats.includes(\"text-summary\") || formats.length !== 1) {\n\t\t\t\t\t\t\t\tlog();\n\t\t\t\t\t\t\t\tlog(`Coverage written to ${chalk.magenta(coverage.output)}`);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tlog();\n\n\t\t\t\t\t// Group our failures by module / test\n\t\t\t\t\tconst grouped = _.forIn(_.groupBy(failures, failure => failure.module), (val, key, obj) => {\n\t\t\t\t\t\t// eslint-disable-next-line no-param-reassign\n\t\t\t\t\t\tobj[key] = _.groupBy(val, failure => failure.name);\n\t\t\t\t\t});\n\n\t\t\t\t\t// Loop through each module\n\t\t\t\t\t_.forIn(grouped, (val, key) => {\n\t\t\t\t\t\tconst hasModule = !!key;\n\n\t\t\t\t\t\tif (hasModule) {\n\t\t\t\t\t\t\tlog(key);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Loop through each test\n\t\t\t\t\t\t_.forIn(val, (tests, name) => {\n\t\t\t\t\t\t\tconst indent = hasModule ? \"  \" : \"\";\n\n\t\t\t\t\t\t\tlog(indent + name);\n\n\t\t\t\t\t\t\t// Print each failure\n\t\t\t\t\t\t\ttests.forEach(({ message, expected, actual }) => {\n\t\t\t\t\t\t\t\tlog(chalk.red(`${indent}  \\u2717 ${message ? `${chalk.gray(message)}` : \"Test failure\"}`));\n\n\t\t\t\t\t\t\t\tif (!_.isUndefined(actual)) {\n\t\t\t\t\t\t\t\t\tlog(`${indent}      expected: ${expected}, actual: ${actual}`);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\tlog();\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\n\t\t\t\t\tlog(chalk.blue(`Took ${response.runtime}ms to run ${response.total} tests. ${response.passed} passed, ${response.failed} failed.`));\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tawait closeBrowser(browser);\n\n\t\t\t\t\t\t// Get rid of our timeout timer because we're done\n\t\t\t\t\t\tclearTimeout(timer);\n\n\t\t\t\t\t\tresolve(\n\t\t\t\t\t\t\tObject.assign(\n\t\t\t\t\t\t\t\t{},\n\t\t\t\t\t\t\t\t{ pass: !response.failed, results: _.omit(Object.assign({}, response), \"runtime\") },\n\t\t\t\t\t\t\t\tspreadObjectIf(coverage, {\n\t\t\t\t\t\t\t\t\tcoverage: coverageReport,\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t);\n\t\t\t\t\t} catch (ex) {\n\t\t\t\t\t\t// This might happen if the timeout exceeded and we already closed.\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} catch (ex) {\n\t\t\t\t// silently handle, for now\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tpage.on(\"load\", async () => {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst qunitMissing = await page.evaluate(() => typeof QUnit === \"undefined\" || !QUnit);\n\n\t\t\t\t\t\tif (qunitMissing) {\n\t\t\t\t\t\t\tlog();\n\t\t\t\t\t\t\tlog(chalk.red(\"Unable to find the QUnit object.\"));\n\t\t\t\t\t\t\tlog();\n\n\t\t\t\t\t\t\tawait closeBrowser(browser, new Error(\"Unable to find the QUnit object\"));\n\t\t\t\t\t\t}\n\t\t\t\t\t} catch (ex) {\n\t\t\t\t\t\t// silently handle, for now\n\t\t\t\t\t}\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst fixture = path.join(path.isAbsolute(filePath) ? \"\" : process.cwd(), filePath);\n\t\t\t\t\t\tconst fixtureName = path.basename(fixture, \".html\");\n\t\t\t\t\t\tconst snapshotDir = path.join(path.dirname(fixture), \"__snapshot__\", fixtureName);\n\n\t\t\t\t\t\tawait page.exposeFunction(\"loadSnapshots\", async () => {\n\t\t\t\t\t\t\tawait fs.ensureDir(snapshotDir);\n\n\t\t\t\t\t\t\tconst files = await glob.sync(path.join(snapshotDir, \"*.snapshot\"));\n\n\t\t\t\t\t\t\treturn files.reduce((snapshots, file) => {\n\t\t\t\t\t\t\t\treturn { ...snapshots, [path.basename(file, \".snapshot\")]: fs.readFileSync(file, \"utf-8\") };\n\t\t\t\t\t\t\t}, {});\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tawait page.exposeFunction(\"setSnapshot\", async (id, snapshot) => {\n\t\t\t\t\t\t\tawait fs.ensureDir(snapshotDir);\n\t\t\t\t\t\t\tawait fs.writeFile(path.join(snapshotDir, id + \".snapshot\"), snapshot);\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tawait page.evaluate(async () => {\n\t\t\t\t\t\t\tconst storage = await window.loadSnapshots();\n\n\t\t\t\t\t\t\twindow.__snapshot__ = {\n\t\t\t\t\t\t\t\tstorage,\n\t\t\t\t\t\t\t\tget(id) {\n\t\t\t\t\t\t\t\t\treturn window.__snapshot__.storage[id];\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\tasync set(id, snapshot) {\n\t\t\t\t\t\t\t\t\twindow.__snapshot__.storage[id] = snapshot;\n\t\t\t\t\t\t\t\t\tawait window.setSnapshot(id, snapshot);\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\tQUnit.done(window.report);\n\t\t\t\t\t\t\tQUnit.log(window.logAssertion);\n\t\t\t\t\t\t\tQUnit.start();\n\t\t\t\t\t\t});\n\t\t\t\t\t} catch (ex) {\n\t\t\t\t\t\t// silently handle, for now.\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} catch (ex) {\n\t\t\t\t// silently handle, for now\n\t\t\t}\n\n\t\t\t// Navigate to our test file\n\t\t\ttry {\n\t\t\t\tawait page.goto(fixturePath);\n\t\t\t} catch (ex) {\n\t\t\t\tlog();\n\t\t\t\tlog(chalk.red(\"Failed to open the test file.\"));\n\t\t\t\tlog();\n\n\t\t\t\tawait closeBrowser(browser, new Error(\"Failed to open the test file.\"));\n\t\t\t}\n\t\t})();\n\t});\n};\n\nmodule.exports = qunitChromeRunner;\n"],"names":["const","chalk","require","istanbul","path","puppeteer","_","fs","glob","spreadObjectIf","condition","element","defaults","timeout","formats","output","process","cwd","puppeteerOptions","verbose","module","exports","filePath","ref","fixturePath","join","isAbsolute","replace","log","console","val","Promise","resolve","reject","closeBrowser","browser","rejection","on","setTimeout","pid","kill","ex","disconnect","magenta","launch","then","$await_12","newPage","page","$await_13","failures","timer","red","Error","fixture","fixtureName","basename","snapshotDir","dirname","exposeFunction","ensureDir","sync","$await_15","reduce","snapshots","file","Object","readFileSync","id","snapshot","writeFile","evaluate","window","loadSnapshots","__snapshot__","$await_20","get","storage","set","setSnapshot","QUnit","done","report","logAssertion","start","$await_23","goto","response","coverageReport","coverage","__coverage__","coverageResults","$await_27","collector","Collector","reporter","Reporter","includes","push","assign","branch","getBranchCoverage","function","getFunctionCoverage","statement","getStatementCoverage","add","addAll","write","length","grouped","forIn","groupBy","failure","key","obj","name","hasModule","tests","indent","forEach","message","gray","isUndefined","actual","expected","blue","clearTimeout","pass","failed","results","omit","result","todo"],"mappings":"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"}